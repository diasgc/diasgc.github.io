<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="mobile-web-app-capable" content="yes">
		<link rel="manifest" href="site.webmanifest">
		<link type="text/css" rel="stylesheet" href="style.css">
	</head>
	<body>
		<h3>Upload a video to transcode to mp4 (x264) and play!</h3>
		<video id="output-video" controls></video><br/>
		<input type="file" id="uploader">
		<p id="message" />
		<script defer type="module">
			import { init, Wasmer } from "https://unpkg.com/@wasmer/sdk@latest/dist/index.mjs";
			const message = document.getElementById('message');
			const transcode = async ({ target: { files }  }) => {
				await init();
				const { name } = files[0];
				let ffmpeg = await Wasmer.fromRegistry("wasmer/ffmpeg");
				let resp = await fetch(name);
				let video = await resp.arrayBuffer();
				// We take stdin ("-") as input and write the output to stdout ("-") as a
				// WAV audio stream.
				const instance = await ffmpeg.entrypoint.run({
				args: ["-i", "-", "-c:v", "libx265", "-"],
				stdin: new Uint8Array(video),
				});
				const { stdoutBytes } = await instance.wait();
				console.log(`The audio stream: ${output.stdoutBytes}`);
			}
			document.getElementById('uploader').addEventListener('change', transcode);
		</script>
	</body>
</html>