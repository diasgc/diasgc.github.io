<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Audio Recorder</title>
  <link rel="manifest" href="site.webmanifest">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéôÔ∏è</text></svg>"/>
  <link rel="stylesheet" href="arec.css">
  <style>
    body {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: Arial, sans-serif;
        margin: 2rem;
    }
    button {
        padding: 1rem 2rem;
        font-size: 1.2rem;
        margin: 0.5rem;
        cursor: pointer;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
    }
    button:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }
    #status {
        margin-top: 1rem;
        color: #666;
    }
</style>
</head>
  <body>
      <button id="recordBtn">Start Recording</button>
      <button id="stopBtn" disabled>Stop & Save</button>
      <div id="status"></div>
  
      <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>
      <script>
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');

        let audioStream;
        let audioContext;
        let sourceNode;
        let workletNode;
        let mp3Chunks = [];
        let encoder;

        // Register worklet processor
        class RecorderWorklet extends AudioWorkletNode {
            constructor(context) {
                super(context, 'recorder-worklet');
            }
        }

        async function startRecording() {
            try {
                status.textContent = "Initializing...";
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 2,
                        sampleRate: 48000,
                        sampleSize: 16
                    }
                });

                audioContext = new AudioContext();
                
                if (audioContext.sampleRate !== 48000) {
                    throw new Error(`Sample rate must be 48kHz (current: ${audioContext.sampleRate}Hz)`);
                }

                // Load and register worklet processor
                await audioContext.audioWorklet.addModule('recorder-worklet.js');
                
                sourceNode = audioContext.createMediaStreamSource(audioStream);
                workletNode = new AudioWorkletNode(audioContext, 'recorder-worklet');

                encoder = new lamejs.Mp3Encoder(2, 48000, 128);

                // Handle data from worklet
                workletNode.port.onmessage = (e) => {
                    const samples = e.data;
                    const mp3Buffer = encoder.encodeBuffer(samples);
                    if (mp3Buffer.length > 0) {
                        mp3Chunks.push(mp3Buffer);
                    }
                };

                sourceNode.connect(workletNode);
                workletNode.connect(audioContext.destination);

                recordBtn.disabled = true;
                stopBtn.disabled = false;
                status.textContent = "Recording...";
            } catch (err) {
                status.textContent = `Error: ${err.message}`;
                console.error(err);
            }
        }

        async function stopRecording() {
            audioStream.getTracks().forEach(track => track.stop());
            sourceNode.disconnect();
            workletNode.disconnect();

            const finalBuffer = encoder.flush();
            if (finalBuffer.length > 0) {
                mp3Chunks.push(finalBuffer);
            }

            const blob = new Blob(mp3Chunks, { type: 'audio/mp3' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `recording_${Date.now()}.mp3`;
            a.click();

            recordBtn.disabled = false;
            stopBtn.disabled = true;
            status.textContent = "Recording saved!";
            mp3Chunks = [];
        }

        recordBtn.addEventListener('click', startRecording);
        stopBtn.addEventListener('click', stopRecording);
      </script>
  </body>
</html>